---
title: "LDA_IGA-NTX"
author: "Sven Morlock"
date: "28/03/2022"
output: pdf_document
---
# § 1

Load required packages:

```{r, message = FALSE, echo = FALSE}
library(ggplot2)
library(survival)
library(survminer)
library(data.table)
library(readxl)
library(forcats)
library(lubridate)
library(dplyr)
```
```{r}
#if (Sys.info()["sysname"] != "Darwin"){
#  default_theme <- theme_minimal() +
#  theme(text = element_text(family = "Decima WE", size = 15)) +
#  theme(panel.grid.major = element_line(color = "grey", size = 0.3)) +
#  theme(axis.line = element_line(color = "black", size = 0.4))
#
#} else {
#  default_theme <- theme_minimal()
#}
default_theme <- theme_minimal()
two_scale_fill <- scale_fill_manual(values=c("#69b3a2", "#404080"))

```

Read data using read_data.R scrip:

```{r,, message = FALSE}
source("read_data.R")
```
\newpage
---
# § 2 EDA

```{r}
follow_up <- years(10)
```

## § 2.1 IGA

```{r}
# follow-up (mean)
(interval(data_iga$`T-date`, data_iga$`T-dls`) / years(1)) %>% 
  mean()
```
```{r}
# patient death within follow up
nrow(data_iga[(`T-dls` <= (`T-date` + follow_up)) & `Pat death (0=alive, 1= dead)` == 1])
```
```{r}
# patient drop out
nrow(data_iga[(`T-dls` <= (`T-date` + follow_up)) & `Pat death (0=alive, 1= dead)` == 0])
```

```{r}
# patients with graft loss 
nrow(data_iga[`graft loss (0=functial, 1=loss)` == 1])
# patients with graft loss within follow up period
nrow(data_iga[`graft loss date` < `T-date` + follow_up])
```

```{r}
# age patients (yrs.)
ggplot(data = data_iga) +
  geom_histogram(mapping = aes(x = interval(`Date of birth`,`T-date`) / years(1),
                               fill = `R-sex`),
                 color="#e9ecef",
                 alpha=0.6,
                 bins = 40) +
  two_scale_fill +
  ylab("Anzahl") +
  xlab("Alter in Jahren") +
  ggtitle("Histogram Alter in Jahren am Transplantationsdatum",
          subtitle =  paste0("(IGA Patienten, n=",
          sum(!is.na(data_iga$`Date of birth`)),
          ")", collapse = "")) +
  labs(fill = "Geschlecht") +
  default_theme
```

```{r}
# male sex
summary(data_iga$`R-sex`)
```

```{r}
# BMI (mean.)
ggplot(data = data_iga) +
  geom_histogram(mapping = aes(`D-weight` * (`D-height`)^2,
                               fill = `D-sex`),
                 alpha = 0.6) +
  two_scale_fill +
  # median BMI total
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             size = 1.0, color = "red", linetype = "dashed") +
  # median BMI F
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             data = data_iga[`R-sex` == "F"], linetype = "dashed") +
  # median BMI M
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             data = data_iga[`R-sex` == "M"], linetype = "dashed") +
  ylab("Anzahl") +
  xlab("BMI") + # Einheit???
  ggtitle("Histogramm BMI", subtitle = paste0("(IGA Patienten, n=",
                                              sum(!is.na(data_iga$`R-height`)),
                                              ")", collapse = "")) +
  labs(fill = "Geschlecht") +
  default_theme
```
```{r}
# deceased D.
# living D.
tbl_1 <- summary(data_iga[`graft loss (0=functial, 1=loss)` == 1]$`D-type`)
tbl_1 <- round(tbl_1 / sum(tbl_1), 3)
tbl_2 <- summary(data_iga[`graft loss (0=functial, 1=loss)` == 0]$`D-type`)
tbl_2 <- round(tbl_2 / sum(tbl_2),3)  # in %
rbind("loss" = tbl_1, "functional" = tbl_2)

tbl_1 <- summary(data_iga[`Pat death (0=alive, 1= dead)` == 1]$`D-type`)
tbl_1 <- round(tbl_1 / sum(tbl_1), 3)
tbl_2<- summary(data_iga[`Pat death (0=alive, 1= dead)` == 0]$`D-type`)
tbl_2 <-  round(tbl_2 / sum(tbl_2),3)  # in %
rbind("dead" = tbl_1, "alive" = tbl_2)
```

```{r}
# BMI (mean.)
mean(data_iga$`D-weight` * (data_iga$`D-height`)^2)
```

```{r}
# HLA-mm (0-6)
## data.table of mm-A, mm-B and mm-DR
tbl_1 <- as.data.table(lapply(data_iga[, c("mm-A", "mm-B", "mm-DR")],
                              as.numeric))
## calculate mean for each column
tbl_2 <- apply(X = tbl_1,
               MARGIN = 2,
               FUN = mean, na.rm = TRUE)
round(tbl_2, 3)
# mean of means
round(mean(tbl_2),3)

## sum of mm-A, mm-B and mm-DR
tbl_3 <- apply(X = tbl_1,
               MARGIN = 1,  
               FUN = sum, na.rm = TRUE)
# mean value
mean(tbl_3)
# median value
sd(tbl_3)
```

```{r}
# PRA current (mean)
# PRA highest (mean)
data_iga[, c("Current PRA%", "Highest PRA%")] %>% 
  apply(MARGIN = 2,
        FUN = mean, na.rm = TRUE)
```

```{r}
# age donor (mean.)
mean(data_iga$`D-age`)
```

```{r}
# cold-ischemia time (hours)
# mean
mean(data_iga$`Cold ischaemic period hours`, na.rm = TRUE)
# median
median(data_iga$`Cold ischaemic period hours`, na.rm = TRUE)
# standard error
sd(data_iga$`Cold ischaemic period hours`, na.rm = TRUE)
```

```{r}
# living vs dead donator
cbind("Living" = nrow(data_iga[`D-type` == "Living"]),
      "Cadaver" = nrow(data_iga[`D-type` == "Cadaver"])
)
```

## § 2.2 NTX

```{r}
# follow_up mean
pmin(
  # follow up
  interval(data_ntx$Datum, (data_ntx$Datum + follow_up)) / years(1),
  # last seen
  interval(data_ntx$Datum, data_ntx$tdls) / years(1)
) %>%
  mean()
```

```{r}
# patient death within follow up
nrow(data_ntx[`Todesdatum[NTX PatientenInformation]` < (Datum + follow_up)])
```

```{r}
# patient drop out
nrow(data_ntx[`Date last seen[NTX PatientenInformation]` <= (Datum + follow_up) & `Patienten Status[NTX PatientenInformation]` == "1 - lebt"])
```

```{r}
# patients with graft loss
nrow(data_ntx[data_ntx$`TX Status[NTX PatientenInformation]` == "2 - ohne Transplantatfunktion"])
```

```{r}
# age patients (yrs.)
ggplot(data = data_ntx) +
  geom_histogram(mapping = aes(x = R_age_Datum, fill = Geschlecht),
                 color = "#e9ecef", alpha = 0.6) +
  two_scale_fill +
  ylab("Anzahl") +
  xlab("Alter in Jahren") +
  ggtitle("Histogram Alter in Jahren am Transplantationsdatum",
          subtitle = paste0("(NTX Patienten, n=", sum(!is.na(data_ntx$R_age_Datum)),
                            ")", collapse = "")) +
  labs(fill = "Geschlecht") +
  default_theme
```

```{r}
# male sex
summary(data_ntx$Geschlecht)
```

```{r}
# BMI (mean.)
## NO DATA AVAILABLE
```

```{r}
# deceased D.
# living D.
## NO DATA AVAILABLE
```

```{r}
# HLA-mm
## NO DATA AVAILABLE
```

```{r}
# PPR
## NO DATA AVAILABLE
```

```{r}
# living vs dead donator
## NO DATA AVAILABLE
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```


\newpage
---
# § 3 Kaplan-Meier


## § 3.1 IGA

```{r}
#  functions in survival and survminer package need numeric-type input
data_iga[, time_date_biopsy := interval(`T-date`, `date of biopsy`) / years(1)]
data_iga[, time_t_dls := interval(`T-date`, `T-dls`) / years(1)]
data_iga[, time_date_birth := interval(`T-date`, `Date of birth`) / years(1)]
data_iga[, time_graft_loss := interval(`T-date`, `graft loss date`) / years(1)]
data_iga[, time_date_follow_up := interval(`T-date`,`T-date` + follow_up) / years(1)]
```
### § 3.1.1 

- Event:
  - graft-loss within the follow up period.
  
- Censoring scheme:
  - if `graft loss date` after follow up period, censored by end of follow up.
  - if `T-dls` (date last seen) within follow up period, censored by `T-dls`.
  
- Time period:
  -  10 years after `T-date` (kidney transplantaion).
```{r}
data_iga <- data_iga %>% 
  mutate(status_date = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ time_graft_loss,
    ## graft-loss after follow up period
    !is.na(`graft loss date`) & `graft loss date` >  `T-date` + follow_up ~ time_date_follow_up,
    ## no graft-loss and last seen within follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## no graft-loss and last seen after follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## no graft loss and no last seen 
    is.na(`graft loss date`) & is.na(`T-dls`) ~ time_date_follow_up
                                )
  )
data_iga <- data_iga %>% 
  mutate(status = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ 1,
    ## else censored
    TRUE ~ 0,
                                )
  )
```

##### Overall kaplan-Meier curve (no stratification)

```{r}
model_iga_1 <- survfit(formula = Surv(time = status_date,
                                   event = status, type = "right")~ 1,
                    data = data_iga)  
ggsurvplot(model_iga_1,
           conf.int = FALSE,
           cumevents = TRUE)
```

### § 3.1.2
- Event: 
  - `T-dls` & ``Pat death (0=alive, 1= dead)` (patient death).
- Censoring scheme:
  - `T-dls` (date last seen) within follow up period.
- Time period:
  - 10 years after `T-date` (kidney transplantation).
```{r}
data_iga <- data_iga %>% 
  mutate(status_date = case_when(
    ## patient death and death date within follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient dead but after follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## patient not death but dropped within follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient not death but dropped after follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## NOTE: T-dls never NA
  )
)
```

```{r}
model_iga_2 <- survfit(formula = Surv(time = status_date,
                                   event = status, type = "right")~ 1,
                    data = data_iga)  
ggsurvplot(model_iga_2,
           conf.int = FALSE,
           cumevents = TRUE)
```

#### § 3.1.3
- Event: graft loss and death
- Censoring scheme:
- Time period:

\newpage
## § 3.2 IGA

### § 3.2.1
- Event: `TX Status[NTX PatientenInformation]`
- Censoring scheme: 
  -if `TX Status[NTX PatientenInformation]` within follow up period then then event
  - if died within follow up  and before no graft loss then censored
  - if last seen within follow up and before no graft loss then censored
  - if graft loss after follow up then censored
- Time period: 10 years after `Datum`

```{r}
data_ntx <- data_ntx %>%
  mutate(status_date = case_when(
    ## patient experienced graft loss
    !is.na(Transplantatfunktionsende) & Transplantatfunktionsende <= (Datum + follow_up) ~ interval(Datum, Transplantatfunktionsende) / years(1),
    ## patient died within follow up
    `Todesdatum[NTX PatientenInformation]` < (Datum + follow_up) ~ interval(Datum, `Todesdatum[NTX PatientenInformation]`) / years(1),
    ## patiend last seen within follow up
    `Date last seen[NTX PatientenInformation]` < (Datum + follow_up) ~ interval(Datum, `Date last seen[NTX PatientenInformation]`) / years(1),
    ## else follow up
    TRUE ~ interval(Datum, (Datum + follow_up)) / years(1)
    )
  )

data_ntx <- data_ntx %>%
  mutate(status = case_when(
    ## patient experienced graft loss
    !is.na(Transplantatfunktionsende) & Transplantatfunktionsende <= (Datum + follow_up) ~ 1,
    ## patient died within follow up 
    `Todesdatum[NTX PatientenInformation]` < (Datum + follow_up) ~ 0,
    ## patiend last seen within follow up
    `Date last seen[NTX PatientenInformation]` < (Datum + follow_up) ~ 0,
    ## else follow up
    TRUE ~ 0
    )
  )
```

```{r}
model_ntx_1 <- survfit(formula = Surv(time = status_date,
                                      event = status, type = "right") ~ 1,
                       data = data_ntx)

ggsurvplot(model_ntx_1,
           conf.int = FALSE,
           cumevents = TRUE)
```

### § 3.2.2

- Event: patient died within follow up period
- Censoring scheme:
  - patient died within follow up then event
  - patient dropped from study within  follow up then censored

```{r}
data_ntx <- data_ntx %>%
  mutate(status_date = case_when(
    ## patient died within follow up
    `Todesdatum[NTX PatientenInformation]` <= (Datum + follow_up) ~ interval(Datum, `Todesdatum[NTX PatientenInformation]`) / years(1),
    ## patient died after follow up
    `Todesdatum[NTX PatientenInformation]` > (Datum + follow_up) ~ interval(Datum, (Datum + follow_up)) / years(1),
    ## patient dropped within follow up
    `Date last seen[NTX PatientenInformation]` <= (Datum + follow_up) ~ interval(Datum, `Date last seen[NTX PatientenInformation]`) / years(1),
    ## patient dropped after follow up
    `Date last seen[NTX PatientenInformation]` > (Datum + follow_up) ~ interval(Datum, (Datum + follow_up)) / years(1)
  )
)


data_ntx <- data_ntx %>%
  mutate(status = case_when(
    ## patient died within follow up
    `Todesdatum[NTX PatientenInformation]` <= (Datum + follow_up) ~ 1,
    ## patient died after follow up
    `Todesdatum[NTX PatientenInformation]` > (Datum + follow_up) ~ 0,
    ## patient dropped within follow up
    `Date last seen[NTX PatientenInformation]` <= (Datum + follow_up) ~ 0,
    ## patient dropped after follow up
    `Date last seen[NTX PatientenInformation]` > (Datum + follow_up) ~ 0
  )
)
```

```{r}
model_ntx_2 <- survfit(Surv(time = status_date, event = status,
                            type = "right") ~1, data = data_ntx)

ggsurvplot(model_ntx_2,
           conf.int = FALSE,
           cumevents = TRUE)
```

```{r}

```

```{r}

```

\newpage
# § 4 Cox regression

## § 4.1 IGA

- Event:
  - graft loss within follow up
- Censoring scheme:
  - if patient dropped within follow up, then censored by time dropped
  - if patient patient experienced graft loss after follow up, then censored by follow up end
  - if patient experienced death within follow up, then censored by death date else by follow up end
```{r}
data_iga <- data_iga %>% 
  ## censor/event date
  mutate(status_date = case_when(
    ## patient dropped during follow up
    (`T-dls` <= `T-date` + follow_up) ~ `T-dls`,
    ## patient experienced graft loss but after follow up
    ((!is.na(`graft loss date`)) &  (`graft loss date` > `T-date` + follow_up)) ~ `T-date` + follow_up,
    ## patient experienced graft loss within follow up
    ((!is.na(`graft loss date`)) &  (`graft loss date` <= `T-date` + follow_up)) ~ `graft loss date`,
    ## patient experienced no graft loss within follow up, neither dropped
    (is.na(`graft loss date`) & (`T-dls` > `T-date` + follow_up)) ~ `T-date` + follow_up
  )) %>% 
  ## status indicator
  mutate(status = case_when(
    ## patient dropped during follow up
    (`T-dls` <= `T-date` + follow_up) ~ 0,
    ## patient experienced graft loss but after follow up
    ((!is.na(`graft loss date`)) &  (`graft loss date` > `T-date` + follow_up)) ~ 0,
    ## patient experienced graft loss within follow up
    ((!is.na(`graft loss date`)) &  (`graft loss date` <= `T-date` + follow_up)) ~ 1,
    ## patient experienced no graft loss within follow up, neither dropped
    (is.na(`graft loss date`) & (`T-dls` > `T-date` + follow_up)) ~ 0
  ))
```

```{r}
data_iga <- data_iga %>%  
  ## censor/event date
  mutate(status_date = case_when(
    ## if graft loss within follow up
    `graft loss date` <= `T-date` + follow_up ~ `graft loss date`,
    ## else
    TRUE ~ `T-dls`
  )) %>% 
  ## censor/event indicator
  mutate(status = case_when(
    ## if graft loss within follow up
    data_iga$`graft loss date` <= data_iga$`T-date` + follow_up ~ 1,
    ## else
    TRUE ~ 0
  ))
```

```{r}
model_iga_cox <- coxph(formula = Surv(time = as.numeric(status_date),
                                       event = status) ~ R_age_Tdate + 
                         ##
                         data_iga$`D-age` +
                         data_iga$`D-sex` +
                         data_iga$`R-sex`,
                         data = data_iga)
summary(model_iga_cox)
```
```{r}
cox.zph(model_iga_cox)
## all p-values are relatively large, therefore the Null hypothesis of proportional hazards can not be rejected
```

## $ 4.2 NTX


```{r}
data_ntx <- data_ntx %>%
  mutate(status_date = case_when(
    ## patient died within follow up
    `Todesdatum[NTX PatientenInformation]` <= (Datum + follow_up) ~ interval(Datum, `Todesdatum[NTX PatientenInformation]`) / years(1),
    ## patient died after follow up
    `Todesdatum[NTX PatientenInformation]` > (Datum + follow_up) ~ interval(Datum, Datum + follow_up) / years(1),
    ## patient dropped within follow up
    `Date last seen[NTX PatientenInformation]` <= (Datum + follow_up) ~ interval(Datum, `Date last seen[NTX PatientenInformation]`) / years(1),
    ## patient dropped after follow up
    `Date last seen[NTX PatientenInformation]` > (Datum + follow_up) ~ interval(Datum, Datum + follow_up) / years(1)
  )
)

data_ntx <- data_ntx %>%
  mutate(status = case_when(
    ## patient died within follow up
    `Todesdatum[NTX PatientenInformation]` <= (Datum + follow_up) ~ 1,
    ## patient died after follow up
    `Todesdatum[NTX PatientenInformation]` > (Datum + follow_up) ~ 0,
    ## patient dropped within follow up
    `Date last seen[NTX PatientenInformation]` <= (Datum + follow_up) ~ 0,
    ## patient dropped after follow up
    `Date last seen[NTX PatientenInformation]` > (Datum + follow_up) ~ 0
    
  )
)
```

```{r}
model_ntx_cox <- coxph(formula = Surv(time = status_date, event = status) ~ R_age_Datum +
                         Geschlecht + `TX Status[NTX PatientenInformation]`,
                       data = data_ntx)

summary(model_ntx_cox)
```

```{r}
cox.zph(model_ntx_cox)
## all p-values are relatively large, therefore the Null hypothesis of proportional hazards can not be rejected
```