---
title: "LDA_IGA-NTX"
author: "Sven Morlock"
date: "28/03/2022"
output: pdf_document
---
# § 1

Load required packages:

```{r, message = FALSE}
library(ggplot2)
library(survival)
library(survminer)
library(xtable)
library(data.table)
library(readxl)
library(forcats)
library(lubridate)
library(dplyr)
```
```{r}
default_theme <- theme_minimal() +
  theme(text = element_text(family = "Decima WE", size = 15)) +
  theme(panel.grid.major = element_line(color = "grey", size = 0.3)) +
  theme(axis.line = element_line(color = "black", size = 0.4))
two_scale_fill <- scale_fill_manual(values=c("#69b3a2", "#404080"))

```

Read data using read_data.R scrip:

```{r,, message = FALSE}
source("read_data.R")
```
\newpage
---
# § 2 EDA

## § 2.1 IGA

```{r}
ggplot(data = data_iga2) +
  geom_histogram(mapping = aes(x = interval(`Date of birth`,`T-date`) / years(1),
                               fill = `R-sex`),
                 color="#e9ecef",
                 alpha=0.6) +
  two_scale_fill +
  # median age total
  geom_vline(aes(xintercept = median(
    interval(`Date of birth`,`T-date`) / years(1))
    ), size = 1.0, color = "red", linetype = "dashed") +
  # median age F
  geom_vline(aes(xintercept = median(
    interval(`Date of birth`,`T-date`) / years(1))
    ), data = data_iga2[`R-sex` == "F"], linetype = "dashed") +
  # median M
  geom_vline(aes(xintercept = median(
    interval(`Date of birth`,`T-date`) / years(1))
    ), data = data_iga2[`R-sex` == "M"], linetype = "dashed") +
  ylab("Anzahl") +
  xlab("Alter in Jahren") +
  ggtitle("Histogram Alter in Jahren am Transplantationsdatum",
          subtitle =  paste0("(IGA Patienten, n=",
          sum(!is.na(data_iga2$`Date of birth`)),
          ")", collapse = "")) +
  labs(fill = "Geschlecht") +
  default_theme
```

```{r}
ggplot(data = data_iga2) +
  geom_histogram(mapping = aes(`D-weight` * (`D-height`)^2,
                               fill = `D-sex`),
                 alpha = 0.6) +
  two_scale_fill +
  # median BMI total
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             size = 1.0, color = "red", linetype = "dashed") +
  # median BMI F
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             data = data_iga2[`R-sex` == "F"], linetype = "dashed") +
  # median BMI M
  geom_vline(aes(xintercept = median(`D-weight` * (`D-height`)^2)),
             data = data_iga2[`R-sex` == "M"], linetype = "dashed") +
  ylab("Anzahl") +
  xlab("BMI") + # Einheit???
  ggtitle("Histogramm BMI", subtitle = paste0("(IGA Patienten, n=",
                                              sum(!is.na(data_iga2$`R-height`)),
                                              ")", collapse = "")) +
  labs(fill = "Geschlecht") +
  default_theme
```
```{r}
ggplot(data = data_iga2) +
  geom_histogram(aes(x = ))

```
## § 2.2 NTX

\newpage
---
# § 3 Kaplan-Meier

```{r}
follow_up <- years(10)
```

## § 3.1 IGA

```{r}
#  functions in survival and survminer package need numeric-type input
data_iga2[, time_date_biopsy := interval(`T-date`, `date of biopsy`) / years(1)]
data_iga2[, time_t_dls := interval(`T-date`, `T-dls`) / years(1)]
data_iga2[, time_date_birth := interval(`T-date`, `Date of birth`) / years(1)]
data_iga2[, time_graft_loss := interval(`T-date`, `graft loss date`) / years(1)]
data_iga2[, time_date_follow_up := interval(`T-date`,`T-date` + follow_up) / years(1)]
```
### § 3.1.1 

- Event:
  - graft-loss within the follow up period.
  
- Censoring scheme:
  - if `graft loss date` after follow up period, censored by end of follow up.
  - if `T-dls` (date last seen) within follow up period, censored by `T-dls`.
  
- Time period:
  -  10 years after `T-date` (kidney transplantaion).
```{r}
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ time_graft_loss,
    ## graft-loss after follow up period
    !is.na(`graft loss date`) & `graft loss date` >  `T-date` + follow_up ~ time_date_follow_up,
    ## no graft-loss and last seen within follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## no graft-loss and last seen after follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## no graft loss and no last seen 
    is.na(`graft loss date`) & is.na(`T-dls`) ~ time_date_follow_up
                                )
  )
data_iga2 <- data_iga2 %>% 
  mutate(event = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ 1,
    ## else censored
    TRUE ~ 0,
                                )
  )
```

##### Overall kaplan-Meier curve (no stratification)

```{r}
model_iga_1 <- survfit(formula = Surv(time = censor_date,
                                   event = event, type = "right")~ 1,
                    data = data_iga2)  
ggsurvplot(model_iga_1,
           conf.int = FALSE,
           cumevents = TRUE)
```

### § 3.1.2
- Event: 
  - `T-dls` & ``Pat death (0=alive, 1= dead)` (patient death).
- Censoring scheme:
  - `T-dls` (date last seen) within follow up period.
- Time period:
  - 10 years after `T-date` (kidney transplantaion).
```{r}
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## patient death and death date within follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient dead but after follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## patient not death but dropped within follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient not death but dropped after follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## NOTE: T-dls never NA
  )
)
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## 
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` < `T-date` + follow_up ~ 1,
    ## else
    TRUE ~ 0
  ))
```

```{r}
model_iga_2 <- survfit(formula = Surv(time = censor_date,
                                   event = event, type = "right")~ 1,
                    data = data_iga2)  
ggsurvplot(model_iga_2,
           conf.int = FALSE,
           cumevents = TRUE)
```

#### § 3.1.3
- Event: graft loss and death
- Censoring scheme:
- Time period: