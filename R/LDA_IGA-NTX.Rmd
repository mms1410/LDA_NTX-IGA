---
title: "LDA_IGA-NTX"
author: "Sven Morlock"
date: "28/03/2022"
output: pdf_document
---
# § 1

Load required packages:

```{r, message = FALSE}
library(ggplot2)
library(survival)
library(survminer)
library(xtable)
library(data.table)
library(readxl)
library(forcats)
library(lubridate)
library(dplyr)
```

Read data using read_data.R scrip:

```{r,, message = FALSE}
source("read_data.R")

```
\newpage
---
# § 2 EDA

## § 2.1 IGA

\newpage
---
# § 3 Kaplan-Meier

```{r}
follow_up <- years(10)
```

## § 3.1 IGA

```{r}
#  functions in survival and survminer package need numeric-type input
data_iga2[, time_date_biopsy := interval(`T-date`, `date of biopsy`) / years(1)]
data_iga2[, time_t_dls := interval(`T-date`, `T-dls`) / years(1)]
data_iga2[, time_date_birth := interval(`T-date`, `Date of birth`) / years(1)]
data_iga2[, time_graft_loss := interval(`T-date`, `graft loss date`) / years(1)]
data_iga2[, time_date_follow_up := interval(`T-date`,`T-date` + follow_up) / years(1)]
```
### § 3.1.1 

- Event:
  - graft-loss within the follow up period.
  
- Censoring scheme:
  - if `graft loss date` after follow up period, censored by end of follow up.
  - if `T-dls` (date last seen) within follow up period, censored by `T-dls`.
  
- Time period:
  -  10 years after `T-date` (kidney transplantaion).
```{r}
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ time_graft_loss,
    ## graft-loss after follow up period
    !is.na(`graft loss date`) & `graft loss date` >  `T-date` + follow_up ~ time_date_follow_up,
    ## no graft-loss and last seen within follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## no graft-loss and last seen after follow up
    is.na(`graft loss date`) & !is.na(`T-dls`) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## no graft loss and no last seen 
    is.na(`graft loss date`) & is.na(`T-dls`) ~ time_date_follow_up
                                )
  )
data_iga2 <- data_iga2 %>% 
  mutate(event = case_when(
    ## graft-loss within follow up period
    !is.na(`graft loss date`) & `graft loss date` <  `T-date` + follow_up ~ 1,
    ## else censored
    TRUE ~ 0,
                                )
  )
```

##### Overall kaplan-Meier curve (no stratification)

```{r}
model_iga_1 <- survfit(formula = Surv(time = censor_date,
                                   event = event, type = "right")~ 1,
                    data = data_iga2)  
ggsurvplot(model_iga_1,
           conf.int = FALSE,
           cumevents = TRUE)
```

### § 3.1.2
- Event: 
  - `T-dls` & ``Pat death (0=alive, 1= dead)` (patient death).
- Censoring scheme:
  - `T-dls` (date last seen) within follow up period.
- Time period:
  - 10 years after `T-date` (kidney transplantaion).
```{r}
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## patient death and death date within follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient dead but after follow up
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## patient not death but dropped within follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` < `T-date` + follow_up ~ time_t_dls,
    ## patient not death but dropped after follow up
    (`Pat death (0=alive, 1= dead)` == 0) & `T-dls` > `T-date` + follow_up ~ time_date_follow_up,
    ## NOTE: T-dls never NA
  )
)
data_iga2 <- data_iga2 %>% 
  mutate(censor_date = case_when(
    ## 
    (`Pat death (0=alive, 1= dead)` == 1) & `T-dls` < `T-date` + follow_up ~ 1,
    ## else
    TRUE ~ 0
  ))
```

```{r}
model_iga_2 <- survfit(formula = Surv(time = censor_date,
                                   event = event, type = "right")~ 1,
                    data = data_iga2)  
ggsurvplot(model_iga_2,
           conf.int = FALSE,
           cumevents = TRUE)
```

#### § 3.1.3
- Event: graft loss and death
- Censoring scheme:
- Time period: